---
title: 跨端通信难题
date: 2021-02-22 11:24:32
tags: Flutter
---
# 跨端通信难题

对于不同架构生态之间做转化，最主要的是运行时对齐，这就涉及到了数据与视图层的同步，JS与Dart的通信问题是一个优秀架构的出口。

## Js 2 WebView 2 Native

基于 Android WebView 的体系下可以在 Java 层通过 WebView 提供的接口注入一个 JavaScriptInterface，JS 就可以得到一个扩展的 API，调用的时候经过 V8 最终反射到 Java 上面。

![javascriptInterfacewebview.png](/images/20210225110444-7np4v72-javascriptInterface_webview.png)

## JS 2 Native

对于使用WebView做中间人，第一是会带来平台相关性的实现；第二是调用路径较长，ReactNative使用了JS2Native的方式，使用了JS Binding 的方案，将原先依赖平台的实现直接下沉到 C++，去实现 JS 对象的扩展。

![js2Native通信.png](/images/20210225110507-spk8c32-js2Native通信.png)

## Flutter通信

### Platform Channel

Flutter 官方提供了一种 Platform Channel 的方案，用于 Dart 和平台之间相互通信。

主要的原理就是将传递的数据编码成消息的形式，跨线程发送到平台接口层，处理之后再将返回的数据通过同样的方式原路返回。

*基于消息和跨线程的处理使得这种方式的通信效率并不高，在骁龙845的机器上测了一组数据，一秒内通过 Platform Channel 只能大概完成四千次左右的相互调用。* （数据来源：WX团队）

![platformChannel.png](/images/20210225110545-snwiplk-platformChannel.png)

![methodchannel通信.png](/images/20210225110600-ahsy7ly-method_channel通信.png)

### Dart FFI

[https://flutter.cn/docs/development/platform-integration/c-interop](https://flutter.cn/docs/development/platform-integration/c-interop)

官方在beta版推出了dart:ffi ，支持了Flutter通过 [dart:ffi](https://api.dart.cn/dev/dart-ffi/dart-ffi-library.html) 库来调用本地的 C++API。

既然JS可以和C++ 相互调用，C++又可以和Dart相互调用，他们结合在一起其实就可以间接的打通JavaScript和Dart。

虽然JavaScript和Dart有各自的执行环境和机制，但通过C++的桥梁依然可以构建一个高效的通道，中间可以通过引用和一些转换（类似JNI）来完成大多数的调用操作和数据传递。

![js2dart.png](/images/20210225110620-6ky5ax8-js2dart.png)

但这并不是说磨平了Android与IOS平台差异性，不同平台的js engine是不同的，对应的js binding也是差异性的,也可以想办法做到js engine对齐，比如hermes、quickjs。