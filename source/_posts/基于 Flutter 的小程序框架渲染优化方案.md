---
title:基于 Flutter 的小程序框架渲染优化方案
date: 2021-02-22 11:24:32
tags: Flutter
---
# 基于 Flutter 的小程序框架方案

## 跨端框架？

对于一个跨端框架，我们希望：

1. 开发工具完善
2. 性能和体验接近原生
3. 基于前端体系
4. 可自定义扩展
5. 可动态发布
6. 可跨多平台
7. 多端UI一致性

## 通信难题

### JS 的通信

---

基于 Android WebView 的体系下可以在 Java 层通过 WebView 提供的接口注入一个 JavaScriptInterface，JS 就可以得到一个扩展的 API，调用的时候经过 V8 最终反射到 Java 上面。

![](https://img.toutiao.io/c/136040fb3d0e3fde2e7f7fe2997034d1)

**在 iOS 上面也是类似的实现，** 这种方式第一是会带来平台相关性的实现；第二是调用路径较长。所以在这个问题上，我们最终使用了 JS Binding 的方案，将原先依赖平台的实现直接下沉到 C++，去实现 JS 对象的扩展，既可以解决跨平台的问题也能带来性能的提升。

### Flutter 的通信

Flutter 官方提供了一种 Platform Channel 的方案，用于 Dart 和平台之间相互通信。主要的原理就是将传递的数据编码成消息的形式，跨线程发送到平台接口层，处理之后再将返回的数据通过同样的方式原路返回。基于消息和跨线程的处理使得这种方式的通信效率并不高，在骁龙845的机器上测了一组数据，一秒内通过 Platform Channel 只能大概完成四千次左右的相互调用。

![](https://img.toutiao.io/c/11bd71d87a3a2e06854dc5e043dbe2d8)

**所以对 Flutter Engine 进行改造增加了一个 dart2cpp 的模块，由Dart直接与C++通信就显得尤为重要。**

**暴露出部分的 C++ 接口，使得外部的动态库可以基于这些接口通过 DartVM 调用到 dart 的接口。在 Dart 的运行环境中 C++ 和 Dart 之间就可以像调用自身的接口一样调用彼此的接口。而且在 AOT 模式下 Dart 会被编译成机器码，所以 C++ 和 Dart 的调用会非常的高效。** **不需要将数据编码成消息和跨线程一系列的复杂流程，而是直接在内存栈上操作数据。**

**dart2cpp 相比于 Platform Channel 的方案提升多少呢，同样的测试案例，一秒内通过 dart2cpp 可以完成三十多万次的相互调用，可以说是极大的提升了通信效率。**

### 两个通信的出口

#### JavaScript与C++通信

![截屏20210222下午12.10.02.png](/images/20210222121004-mheu475-截屏2021-02-22 下午12.10.02.png)

#### C++与Dart通信

![截屏20210222下午12.11.16.png](/images/20210222121117-2a3i37v-截屏2021-02-22 下午12.11.16.png)

#### Js2Dart

既然JS可以和C++ 相互调用，C++又可以和Dart相互调用，他们结合在一起其实就可以间接的打通JavaScript和Dart，虽然JavaScript和Dart有各自的执行环境和机制，但通过C++的桥梁依然可以构建一个高效的通道，中间可以通过引用和一些转换（类似JNI）来完成大多数的调用操作和数据传递。

![](https://img.toutiao.io/c/7d4de14862992860613861f3b49b0581)

## 基于 Flutter 的小程序框架整体架构

将UI信息布局计算好再交给抽象的Flutter Engine去绘制。

// TODO